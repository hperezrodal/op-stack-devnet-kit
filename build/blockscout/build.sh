#!/bin/bash

# references: https://docs.blockscout.com/setup/deployment/docker-compose-deployment

export $(grep -v '^#' env | xargs -d '\n')

MYHOME=$(pwd)

rm -rf $WORK_DIR
mkdir -p $WORK_DIR

cp -r ./docker-compose $WORK_DIR/

echo "Replacing envs/common-blockscout.env values..."
FILE_PATH="$WORK_DIR/docker-compose/envs/common-blockscout.env"

BLOCKSCOUT_ENV_ETHEREUM_JSONRPC_HTTP_URL="$JSONRPC_HTTP_URL/"
BLOCKSCOUT_ENV_ETHEREUM_JSONRPC_TRACE_URL="$JSONRPC_HTTP_URL/"
BLOCKSCOUT_ENV_SUBNETWORK="$NETWORK_NAME"
BLOCKSCOUT_ENV_LOGO="$LOGO"
BLOCKSCOUT_ENV_CHAIN_ID="$CHAIN_ID"

echo "ETHEREUM_JSONRPC_HTTP_URL=$BLOCKSCOUT_ENV_ETHEREUM_JSONRPC_HTTP_URL"
echo "ETHEREUM_JSONRPC_TRACE_URL=$BLOCKSCOUT_ENV_ETHEREUM_JSONRPC_TRACE_URL"
echo "SUBNETWORK=$BLOCKSCOUT_ENV_SUBNETWORK=$NETWORK_NAME"
echo "LOGO=$BLOCKSCOUT_ENV_LOGO"
echo "CHAIN_ID=$BLOCKSCOUT_ENV_CHAIN_ID"

sed -i "s|^ETHEREUM_JSONRPC_HTTP_URL=.*|ETHEREUM_JSONRPC_HTTP_URL=$BLOCKSCOUT_ENV_ETHEREUM_JSONRPC_HTTP_URL|" $FILE_PATH
sed -i "s|^ETHEREUM_JSONRPC_TRACE_URL=.*|ETHEREUM_JSONRPC_TRACE_URL=$BLOCKSCOUT_ENV_ETHEREUM_JSONRPC_TRACE_URL|" $FILE_PATH
sed -i "s|^SUBNETWORK=.*|SUBNETWORK=$BLOCKSCOUT_ENV_SUBNETWORK|" $FILE_PATH
sed -i "s|^LOGO=.*|LOGO=$BLOCKSCOUT_ENV_LOGO|" $FILE_PATH
sed -i "s|^CHAIN_ID=.*|CHAIN_ID=$BLOCKSCOUT_ENV_CHAIN_ID|" $FILE_PATH

echo "Replacing envs/common-frontend.env values..."
FILE_PATH="$WORK_DIR/docker-compose/envs/common-frontend.env"

FRONTEND_ENV_NEXT_PUBLIC_API_HOST="$API_HOST"
FRONTEND_ENV_NEXT_PUBLIC_STATS_API_HOST="$STATS_API_URL"
FRONTEND_ENV_NEXT_PUBLIC_NETWORK_NAME="$NETWORK_NAME"
FRONTEND_ENV_NEXT_PUBLIC_NETWORK_SHORT_NAME="$NETWORK_SHORT_NAME"
FRONTEND_ENV_NEXT_PUBLIC_NETWORK_ID="$CHAIN_ID"
FRONTEND_ENV_NEXT_PUBLIC_NETWORK_CURRENCY_NAME="$CURRENCY_NAME"
FRONTEND_ENV_NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL="$CURRENCY_SYMBOL"
FRONTEND_ENV_NEXT_PUBLIC_APP_HOST="$API_HOST"
FRONTEND_ENV_NEXT_PUBLIC_VISUALIZE_API_HOST="$VISUALIZE_API_URL"
FRONTEND_ENV_NEXT_PUBLIC_IS_TESTNET="$IS_TESTNET"

sed -i "s|^NEXT_PUBLIC_API_HOST=.*|NEXT_PUBLIC_API_HOST=$FRONTEND_ENV_NEXT_PUBLIC_API_HOST|" $FILE_PATH
sed -i "s|^NEXT_PUBLIC_STATS_API_HOST=.*|NEXT_PUBLIC_STATS_API_HOST=$FRONTEND_ENV_NEXT_PUBLIC_STATS_API_HOST|" $FILE_PATH
sed -i "s|^NEXT_PUBLIC_NETWORK_NAME=.*|NEXT_PUBLIC_NETWORK_NAME=$FRONTEND_ENV_NEXT_PUBLIC_NETWORK_NAME|" $FILE_PATH
sed -i "s|^NEXT_PUBLIC_NETWORK_SHORT_NAME=.*|NEXT_PUBLIC_NETWORK_SHORT_NAME=$FRONTEND_ENV_NEXT_PUBLIC_NETWORK_SHORT_NAME|" $FILE_PATH
sed -i "s|^NEXT_PUBLIC_NETWORK_ID=.*|NEXT_PUBLIC_NETWORK_ID=$FRONTEND_ENV_NEXT_PUBLIC_NETWORK_ID|" $FILE_PATH
sed -i "s|^NEXT_PUBLIC_NETWORK_CURRENCY_NAME=.*|NEXT_PUBLIC_NETWORK_CURRENCY_NAME=$FRONTEND_ENV_NEXT_PUBLIC_NETWORK_CURRENCY_NAME|" $FILE_PATH
sed -i "s|^NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL=.*|NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL=$FRONTEND_ENV_NEXT_PUBLIC_NETWORK_CURRENCY_SYMBOL|" $FILE_PATH
sed -i "s|^NEXT_PUBLIC_APP_HOST=.*|NEXT_PUBLIC_APP_HOST=$FRONTEND_ENV_NEXT_PUBLIC_APP_HOST|" $FILE_PATH
sed -i "s|^NEXT_PUBLIC_VISUALIZE_API_HOST=.*|NEXT_PUBLIC_VISUALIZE_API_HOST=$FRONTEND_ENV_NEXT_PUBLIC_VISUALIZE_API_HOST|" $FILE_PATH
sed -i "s|^NEXT_PUBLIC_IS_TESTNET=.*|NEXT_PUBLIC_IS_TESTNET=$FRONTEND_ENV_NEXT_PUBLIC_IS_TESTNET|" $FILE_PATH

echo "Replacing docker-compose.yml values..."
FILE_PATH="$WORK_DIR/docker-compose/docker-compose.yml"

DOCKER_COMPOSE_ENV_ETHEREUM_JSONRPC_HTTP_URL="$JSONRPC_HTTP_URL/"
DOCKER_COMPOSE_ENV_CHAIN_ID="'$CHAIN_ID'"

sed -i "s|ETHEREUM_JSONRPC_HTTP_URL: .*|ETHEREUM_JSONRPC_HTTP_URL: $DOCKER_COMPOSE_ENV_ETHEREUM_JSONRPC_HTTP_URL|" "$FILE_PATH"
sed -i "s|CHAIN_ID: .*|CHAIN_ID: $DOCKER_COMPOSE_ENV_CHAIN_ID|" $FILE_PATH

echo "Done!"

